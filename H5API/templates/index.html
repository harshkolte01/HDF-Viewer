<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>H5API – HDF5 File Browser</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg:         #F8FAFF;
      --surface:    #FFFFFF;
      --surface-alt:#F2F6FF;
      --border:     #D9E2F2;
      --text:       #0F172A;
      --text-sec:   #475569;
      --primary:    #2563EB;
      --primary-hov:#1D4ED8;
      --accent:     #38BDF8;
      --success:    #16A34A;
      --success-bg: #ECFDF3;
      --error:      #DC2626;
      --error-bg:   #FEF2F2;
      --warn:       #D97706;
      --warn-bg:    #FFFBEB;
      --info:       #0EA5E9;
      --info-bg:    #F0F9FF;
      --radius:     10px;
      --shadow-sm:  0 1px 3px rgba(15,23,42,.08), 0 1px 2px rgba(15,23,42,.06);
      --shadow:     0 4px 12px rgba(15,23,42,.10), 0 2px 6px rgba(15,23,42,.06);
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 15px; }
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ── Topbar ── */
    .topbar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 32px;
      height: 60px;
      display: flex;
      align-items: center;
      gap: 14px;
      box-shadow: var(--shadow-sm);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .topbar-logo { display: flex; align-items: center; gap: 10px; text-decoration: none; cursor: pointer; }
    .topbar-icon {
      width: 32px; height: 32px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
    }
    .topbar-icon svg { width: 18px; height: 18px; fill: #fff; }
    .topbar-title { font-size: 1.05rem; font-weight: 700; color: var(--text); letter-spacing: -.3px; }
    .topbar-subtitle { font-size: .75rem; color: var(--text-sec); }
    .topbar-spacer { flex: 1; }
    .bucket-badge {
      font-size: .72rem; font-weight: 600;
      padding: 3px 10px; border-radius: 999px;
      background: var(--info-bg); color: var(--info); border: 1px solid #BAE6FD;
    }

    /* ── Main ── */
    .main { max-width: 1100px; margin: 0 auto; padding: 32px 24px 64px; }

    /* ── Breadcrumb ── */
    .breadcrumb {
      display: flex; align-items: center; flex-wrap: wrap;
      gap: 4px; margin-bottom: 24px; font-size: .85rem;
    }
    .breadcrumb-item {
      color: var(--primary); text-decoration: none; font-weight: 500;
      padding: 4px 8px; border-radius: 6px; transition: background .15s; cursor: pointer; border: none; background: none;
      font-family: inherit; font-size: inherit;
    }
    .breadcrumb-item:hover { background: var(--surface-alt); }
    .breadcrumb-sep { color: var(--border); }
    .breadcrumb-cur {
      padding: 4px 8px; border-radius: 6px;
      background: var(--surface-alt); color: var(--text-sec); font-weight: 500;
    }

    /* ── Stats ── */
    .stats { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
    .stat-chip {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: .78rem; font-weight: 600; padding: 5px 12px;
      border-radius: 999px; border: 1px solid var(--border);
      background: var(--surface); color: var(--text-sec);
    }
    .stat-chip svg { width: 14px; height: 14px; }
    .stat-chip.folders { color: var(--warn); border-color: #FDE68A; background: var(--warn-bg); }
    .stat-chip.files   { color: var(--primary); border-color: #BFDBFE; background: var(--info-bg); }

    /* ── Error banner ── */
    .error-banner {
      display: flex; align-items: flex-start; gap: 12px;
      padding: 16px 20px; border-radius: var(--radius);
      background: var(--error-bg); border: 1px solid #FECACA;
      color: var(--error); font-size: .875rem; margin-bottom: 24px;
    }
    .error-banner svg { width: 20px; height: 20px; flex-shrink: 0; margin-top: 1px; }
    .error-title { font-weight: 600; margin-bottom: 2px; }

    /* ── Loader ── */
    .loader {
      display: flex; align-items: center; gap: 12px;
      padding: 40px; color: var(--text-sec); justify-content: center;
      font-size: .9rem;
    }
    .spinner {
      width: 22px; height: 22px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin .7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Empty ── */
    .empty { text-align: center; padding: 64px 24px; color: var(--text-sec); }
    .empty svg { width: 48px; height: 48px; margin: 0 auto 16px; opacity: .35; display: block; }
    .empty h3 { font-size: 1.05rem; font-weight: 600; margin-bottom: 6px; color: var(--text); }
    .empty p { font-size: .875rem; }

    /* ── Section label ── */
    .section-label {
      font-size: .7rem; font-weight: 700; letter-spacing: .08em;
      text-transform: uppercase; color: var(--text-sec); margin: 8px 0 10px;
    }

    /* ── Folder grid ── */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px; margin-bottom: 28px;
    }
    .folder-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 16px 18px;
      display: flex; align-items: center; gap: 14px;
      cursor: pointer; text-decoration: none; color: var(--text);
      transition: border-color .18s, box-shadow .18s, transform .12s;
      box-shadow: var(--shadow-sm);
    }
    .folder-card:hover { border-color: #93C5FD; box-shadow: var(--shadow); transform: translateY(-2px); }
    .folder-card:active { transform: translateY(0); }
    .folder-icon {
      width: 40px; height: 40px; border-radius: 8px;
      background: var(--warn-bg);
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .folder-icon svg { width: 22px; height: 22px; fill: var(--warn); }
    .folder-name { font-size: .875rem; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* ── File table ── */
    .file-table-wrap {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); overflow: hidden;
      box-shadow: var(--shadow-sm); margin-bottom: 28px;
    }
    .file-table { width: 100%; border-collapse: collapse; font-size: .875rem; }
    .file-table thead { background: var(--surface-alt); border-bottom: 1px solid var(--border); }
    .file-table th {
      padding: 10px 18px; text-align: left;
      font-size: .72rem; font-weight: 700; letter-spacing: .06em;
      text-transform: uppercase; color: var(--text-sec);
    }
    .file-table tbody tr { border-bottom: 1px solid var(--border); transition: background .12s; }
    .file-table tbody tr:last-child { border-bottom: none; }
    .file-table tbody tr:hover { background: var(--surface-alt); }
    .file-table td { padding: 12px 18px; vertical-align: middle; }
    .file-cell { display: flex; align-items: center; gap: 12px; }
    .file-icon {
      width: 34px; height: 34px; border-radius: 7px;
      background: var(--info-bg);
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .file-icon svg { width: 18px; height: 18px; fill: var(--info); }
    .file-name { font-weight: 600; color: var(--text); }
    .file-ext {
      display: inline-block; margin-left: 6px; font-size: .68rem; font-weight: 700;
      background: var(--primary); color: #fff;
      padding: 1px 6px; border-radius: 4px; letter-spacing: .04em; vertical-align: middle;
    }
    .file-size { color: var(--text-sec); white-space: nowrap; }
    .file-date { color: var(--text-sec); font-size: .8rem; white-space: nowrap; }
    .go-btn {
      display: inline-flex; align-items: center; gap: 5px;
      font-size: .75rem; font-weight: 600; padding: 4px 12px;
      border-radius: 6px; border: 1px solid var(--primary);
      background: var(--primary); color: #fff;
      cursor: pointer; transition: background .14s, border-color .14s, transform .1s; font-family: inherit;
    }
    .go-btn:hover { background: var(--primary-hov); border-color: var(--primary-hov); transform: translateY(-1px); }
    .go-btn:active { transform: translateY(0); }
    .go-btn svg { width: 12px; height: 12px; }

    @media (max-width: 640px) {
      .topbar { padding: 0 16px; }
      .main { padding: 20px 12px 48px; }
      .grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 8px; }
      .file-table th:nth-child(3), .file-table td:nth-child(3),
      .file-table th:nth-child(4), .file-table td:nth-child(4) { display: none; }
    }
  </style>
</head>
<body>

<header class="topbar">
  <div class="topbar-logo" onclick="navigate('')">
    <span class="topbar-icon">
      <svg viewBox="0 0 24 24"><path d="M20 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2ZM4 4h11l2 3H4V4Z"/></svg>
    </span>
    <span>
      <div class="topbar-title">H5API</div>
      <div class="topbar-subtitle">HDF5 File Browser</div>
    </span>
  </div>
  <span class="topbar-spacer"></span>
  <span class="bucket-badge" id="bucketBadge">loading…</span>
</header>

<main class="main">
  <nav class="breadcrumb" id="breadcrumb" aria-label="Breadcrumb"></nav>
  <div class="stats" id="stats"></div>
  <div id="content">
    <div class="loader"><div class="spinner"></div> Connecting to MinIO…</div>
  </div>
</main>

<script>
  // ── Config ─────────────────────────────────────────────────────
  // The Flask server is always at port 5100; this page may be served
  // from anywhere (Flask itself or python -m http.server).
  const API_BASE = 'https://hdf-viewer.vercel.app';

  // Base URL of the HDF5 Viewer app — used by the "Go" button.
  // Override by setting window.__VIEWER_BASE__ before this script runs.
  const VIEWER_BASE = (window.__VIEWER_BASE__ || 'https://hdf-viewer-old-web.vercel.app').replace(/\/+$/, '');

  let currentPrefix = '';
  let currentBucket = '';

  // ── Routing ────────────────────────────────────────────────────
  function navigate(prefix) {
    currentPrefix = prefix;
    history.pushState({ prefix }, '', prefix ? `?prefix=${encodeURIComponent(prefix)}` : '/');
    loadBrowse(prefix);
  }

  window.addEventListener('popstate', (e) => {
    const p = e.state?.prefix ?? new URLSearchParams(location.search).get('prefix') ?? '';
    currentPrefix = p;
    loadBrowse(p);
  });

  // ── API ─────────────────────────────────────────────────────────
  async function loadBrowse(prefix) {
    const content = document.getElementById('content');
    content.innerHTML = '<div class="loader"><div class="spinner"></div> Loading…</div>';

    try {
      const url = `${API_BASE}/api/browse${prefix ? '?prefix=' + encodeURIComponent(prefix) : ''}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      if (!data.success) throw new Error(data.error || 'Unknown error');
      render(data);
    } catch (err) {
      renderError(err.message);
    }
  }

  // ── Render ──────────────────────────────────────────────────────
  function render(data) {
    // Bucket badge
    currentBucket = data.bucket ?? 'hdf5files';
    document.getElementById('bucketBadge').textContent = currentBucket;

    // Breadcrumbs
    const bc = document.getElementById('breadcrumb');
    bc.innerHTML = data.breadcrumbs.map((crumb, i) => {
      const isLast = i === data.breadcrumbs.length - 1;
      if (isLast) return `<span class="breadcrumb-cur">${esc(crumb.name)}</span>`;
      return `<button class="breadcrumb-item" onclick="navigate('${esc(crumb.prefix)}')">${esc(crumb.name)}</button><span class="breadcrumb-sep">›</span>`;
    }).join('');

    // Stats
    document.getElementById('stats').innerHTML = `
      <span class="stat-chip folders">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2ZM4 4h11l2 3H4V4Z"/></svg>
        ${data.folders.length} folder${data.folders.length !== 1 ? 's' : ''}
      </span>
      <span class="stat-chip files">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9l-7-7Zm4 18H7V4h5v6h5v10Z"/></svg>
        ${data.files.length} file${data.files.length !== 1 ? 's' : ''}
      </span>`;

    // Content
    const content = document.getElementById('content');
    let html = '';

    if (data.folders.length) {
      html += `<div class="section-label">Folders</div><div class="grid">`;
      for (const folder of data.folders) {
        const key = folder.key.replace(/\/$/, '');
        html += `
          <div class="folder-card" onclick="navigate('${esc(key)}')">
            <span class="folder-icon">
              <svg viewBox="0 0 24 24"><path d="M20 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2ZM4 4h11l2 3H4V4Z"/></svg>
            </span>
            <div class="folder-name" title="${esc(folder.name)}">${esc(folder.name)}</div>
          </div>`;
      }
      html += `</div>`;
    }

    if (data.files.length) {
      html += `<div class="section-label">HDF5 Files</div><div class="file-table-wrap"><table class="file-table">
        <thead><tr><th>Name</th><th>Size</th><th>Last Modified</th><th>Open</th></tr></thead><tbody>`;
      for (const file of data.files) {
        const parts = file.name.split('.');
        const ext = parts.length > 1 ? parts.pop().toUpperCase() : '';
        const base = parts.join('.');
        const sizeMB = (file.size / 1024 / 1024).toFixed(2);
        const date = (file.last_modified || '').slice(0, 16).replace('T', ' ');
        html += `
          <tr>
            <td><div class="file-cell">
              <span class="file-icon"><svg viewBox="0 0 24 24"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9l-7-7Zm4 18H7V4h5v6h5v10Z"/></svg></span>
              <div><span class="file-name">${esc(base)}</span><span class="file-ext">${esc(ext)}</span></div>
            </div></td>
            <td class="file-size">${sizeMB} MB</td>
            <td class="file-date">${esc(date)} UTC</td>
            <td><button class="go-btn" onclick="goToFile('${esc(file.key)}')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
              Go
            </button></td>
          </tr>`;
      }
      html += `</tbody></table></div>`;
    }

    if (!data.folders.length && !data.files.length) {
      html = `<div class="empty">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2ZM4 4h11l2 3H4V4Z"/></svg>
        <h3>No HDF5 files found</h3>
        <p>This folder is empty or contains no .h5 / .hdf5 files.</p>
      </div>`;
    }

    content.innerHTML = html;
  }

  function renderError(msg) {
    document.getElementById('content').innerHTML = `
      <div class="error-banner">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1 0 0 20A10 10 0 0 0 12 2Zm1 15h-2v-2h2v2Zm0-4h-2V7h2v6Z"/></svg>
        <div><div class="error-title">Connection Error</div><div>${esc(msg)}</div></div>
      </div>`;
  }

  // ── Utils ───────────────────────────────────────────────────────
  function esc(str) {
    return String(str ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }

  function goToFile(key) {
    const url = `${VIEWER_BASE}/?file=${encodeURIComponent(key)}&bucket=${encodeURIComponent(currentBucket)}`;
    window.open(url, '_blank');
  }

  // ── Init ────────────────────────────────────────────────────────
  const initPrefix = new URLSearchParams(location.search).get('prefix') ?? '';
  loadBrowse(initPrefix);
</script>
</body>
</html>
